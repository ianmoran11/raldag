---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# raldag

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![Codecov test coverage](https://codecov.io/gh/ianmoran11/raldag/branch/master/graph/badge.svg)](https://codecov.io/gh/ianmoran11/raldag?branch=master)
[![R-CMD-check](https://github.com/ianmoran11/raldag/workflows/R-CMD-check/badge.svg)](https://github.com/ianmoran11/raldag/actions)
<!-- badges: end -->

`raldag` helps you create DAGs and generate data from them. 

```{r echo = FALSE, message = FALSE, warning = FALSE}
rm(list = ls())
library(tidyverse)
library(tidygraph)
library(ggraph)
library(patchwork)
library(magrittr)
library(ralget)
library(ggforce)
library(raldag)
library("conflicted")
options(dplyr.print_max = 3,dplyr.print_min = 3)
conflict_prefer("do", "raldag")
conflict_prefer("filter", "dplyr")
conflict_prefer("simulate", "raldag")
```

```{r,echo = FALSE, message=FALSE, warning=FALSE, include=FALSE}
format <- theme(plot.title = element_text(hjust = 0.5)) +  theme(panel.background = element_rect(fill = rgb(.95,.95,.95,1),color = NA)) 

plotter <- function(graph){
  graph %>% 
      ggraph()  +
      geom_edge_link(
        aes(end_cap = circle(10, "pt"),
            start_cap = circle(10, "pt")),
        edge_colour = "black",
        arrow = arrow(
          angle = 15,
          length = unit(0.15, "inches"),
          ends = "last",
          type = "closed"
        )
      ) +
      geom_node_point(col = "grey66", size = 10, show.legend = FALSE) +
      geom_node_text(aes(label = name)) +
      theme_graph() + format 
}

```

### Specify how nodes generate data and evaluate inputs

Declare the nodes of your DAG and how data is generated by those nodes with the following code:

```{r message = FALSE, warning = FALSE}
c <- v("c", .f = d(~ rnorm(n = 10^4, mean = rsum(.x) + 10, sd =  4)))
a <- v("a", .f = d(~ rnorm(n = 10^4, mean = rsum(.x)     , sd =  1)))
x <- v("x", .f = d(~ rnorm(n = 10^4, mean = rsum(.x) + 30, sd =  4)))
y <- v("y", .f = d(~ rnorm(n = 10^4, mean = rsum(.x) +  7, sd =  2)))
m <- v("m", .f = d(~ rnorm(n = 10^4, mean = rsum(.x) + 40, sd =  2)))
```

In this case, the node `c` generates 1000 observations with a mean equal to the sum of its input edges plus 10 and a standard deviation of 4.  

### Declare causal connections

Causal connections between nodes as well as coefficients are specified with the graph syntax from [ralget](https://github.com/ianmoran11/ralget)

```{r echo=TRUE, message=FALSE, warning=FALSE, include = TRUE, results = "hide"}
 (a * b(9) + m * b(1)) * x +
 (c * b(2) + m * b(5)) * y +
 (a * b(3) + c * b(5)) * m
```

```{r echo=FALSE, message=FALSE, warning=FALSE, include = TRUE, fig.height=5, fig.width=12}
g <-
 (a * b(9) + m * b(1)) * x +
 (c * b(2) + m * b(5)) * y +
 (a * b(3) + c * b(5)) * m

blank_plot <- ggplot(NULL) + theme(panel.background = element_rect(fill = 'white', colour = 'white'))
(plotter(g) + xlim(c(.45,1.55)) + ylim(c(1,3))   ) +
blank_plot + blank_plot
```

### Generate data from DAG

Now that we have a DAG with an underlying data generating process, we can simulate data:

```{r message = FALSE, warning = FALSE}
g %>% simulate(seed = 123)
```

### Introduce interventions

We can also examine causal effects using interventions, inspired by Pearl's [do-calculus](https://en.wikipedia.org/wiki/Causal_model#Do_calculus).

For example, we can set `a` to 0:
```{r message = FALSE, warning = FALSE}
g %>% raldag::do(m = 0) %>% simulate(seed = 123)
```

And we could compare that with what happens when `a` is set to 1:
```{r message = FALSE, warning = FALSE}
g %>% raldag::do(a = 1) %>% simulate(seed = 123)
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
obs <- g %>% simulate(label = "Observational")
do0 <- g %>% raldag::do(a = 0) %>% simulate(label = "do(a = 0)",seed = 1)
do1 <- g %>% raldag::do(a = 1) %>% simulate(label = "do(a = 1)",seed = 1)
```

### Compare intervention distributions

Here's how our intervention on `a` has affected the variables in our DAG/DGP.
```{r echo=TRUE, message=FALSE, warning=FALSE, include = TRUE, fig.height=7, fig.width=10}
bind_rows(obs, do0, do1) %>% 
  gather(var,value, -sim_id,-label) %>%
  plot_distributions()
```

## Installation
You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("ianmoran11/raldag")
```
